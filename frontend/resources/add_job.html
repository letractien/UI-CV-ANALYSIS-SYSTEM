<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Description</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>

<body>
    <header class="d-flex justify-content-between align-items-center p-2 bg-light border-bottom">
        <div class="d-flex align-items-center">
            <img src="/frontend/static/image/logo.png" alt="Company Logo" width="40" height="40" class="me-2">
            <h5 class="m-0">LT Company</h5>
        </div>
        <button class="btn btn-outline-secondary">
            <i class="fas fa-bell"></i>
        </button>
    </header>

    <div class="d-flex">
        <aside class="bg-light p-3" style="min-width: 250px; height: calc(100vh - 75px);">
            <div class="text-center mb-3">
                <img src="/frontend/static/image/face.jpg" class="rounded-circle" width="50" height="50">
                <h5 class="mt-2">Garo</h5>
                <p class="text-muted">HR Manager</p>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a href="/" class="nav-link text-dark d-flex align-items-center gap-2"><i
                            class="fas fa-chart-line"></i>Dashboard</a>
                </li>
                <li class="nav-item">
                    <a href="/job" class="nav-link d-flex align-items-center gap-2 active"><i
                            class="fas fa-users"></i>Job</a>
                </li>
            </ul>
            <ul class="nav flex-column position-absolute bottom-0 start-0 p-3">
                <li class="nav-item">
                    <a href="#" class="nav-link text-dark d-flex align-items-center gap-2">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link text-dark d-flex align-items-center gap-2">
                        <i class="fas fa-cog"></i>
                        <span>Setting</span>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="container p-4" style="overflow-y: auto; height: calc(100vh - 75px);">
            <h1 class="mb-4">Job Description</h1>
            <form onsubmit="submitForm(event)">
                <div class="mb-4">
                    <label for="name" class="form-label fw-bold">Name Job</label>
                    <input required type="text" class="form-control" id="name" placeholder="Enter name Job">
                </div>

                <h5>Background</h5>
                <div id="background" class="mb-1">
                    <label class="mb-1">Importance ratio</label>
                    <div class="input-group mb-1">
                        <input required step="1" type="number" class="form-control importance-input"
                            placeholder="Enter importance ratio | Max = 100%" min="0" max="100">
                        <span class="input-group-text">%</span>
                    </div>
                    <label class="mb-1">Required</label>
                    <textarea rows="1" class="form-control mb-1"
                        placeholder="Enter assessment criteria | Sinh viên năm cuối hoặc mới tốt nghiệp ngành Công nghệ Thông tin, Khoa học Máy tính, Kỹ thuật Phần mềm hoặc các ngành liên quan."></textarea>
                    <label class="mb-1">Evaluation criteria</label>
                </div>
                <button type="button" class="btn btn-secondary mb-4" onclick="addCriterion('background')">+ Add
                    Criterion</button>

                <h5>Project evaluation criteria</h5>
                <div id="project" class="mb-1">
                    <label class="mb-1">Importance ratio</label>
                    <div class="input-group mb-1">
                        <input required step="1" type="number" class="form-control importance-input"
                            placeholder="Enter importance ratio | Max = 100%" min="0" max="100">
                        <span class="input-group-text">%</span>
                    </div>
                    <label class="mb-1">Required</label>
                    <textarea rows="1" class="form-control mb-1"
                        placeholder="Enter assessment criteria | Có kinh nghiệm tham gia các dự án phần mềm (trong trường học hoặc cá nhân) là một lợi thế."></textarea>
                    <label class="mb-1">Evaluation criteria</label>
                </div>
                <button type="button" class="btn btn-secondary mb-4" onclick="addCriterion('project')">+ Add
                    Criterion</button>

                <h5>Skill evaluation criteria</h5>
                <div id="skill" class="mb-1">
                    <label class="mb-1">Importance ratio</label>
                    <div class="input-group mb-1">
                        <input required step="1" type="number" class="form-control importance-input"
                            placeholder="Enter importance ratio | Max = 100%" min="0" max="100">
                        <span class="input-group-text">%</span>
                    </div>
                    <label class="mb-1">Required</label>
                    <textarea rows="1" class="form-control mb-1"
                        placeholder="Enter assessment criteria | Có kiến thức cơ bản về lập trình, thuật toán, cấu trúc dữ liệu. Thành thạo ít nhất một trong các ngôn ngữ lập trình: Java, Python, C#, JavaScript,... Hiểu biết về mô hình MVC, REST API là một lợi thế. Có khả năng làm việc nhóm, tư duy logic, giải quyết vấn đề tốt. Chủ động, ham học hỏi và sẵn sàng tiếp thu công nghệ mới."></textarea>
                    <label class="mb-1">Evaluation criteria</label>
                </div>
                <button type="button" class="btn btn-secondary mb-4" onclick="addCriterion('skill')">+ Add
                    Criterion</button>

                <h5>Certification evaluation criteria</h5>
                <div id="certification" class="mb-1">
                    <label class="mb-1">Importance ratio</label>
                    <div class="input-group mb-1">
                        <input required step="1" type="number" class="form-control importance-input"
                            placeholder="Enter importance ratio | Max = 100%" min="0" max="100">
                        <span class="input-group-text">%</span>
                    </div>
                    <label class="mb-1">Required</label>
                    <textarea rows="1" class="form-control mb-1"
                        placeholder="Enter assessment criteria | Không bắt buộc, nhưng có chứng chỉ liên quan đến lập trình (VD: OCA, AWS Certified Developer) là một lợi thế."></textarea>
                    <label class="mb-1">Evaluation criteria</label>
                </div>
                <button type="button" class="btn btn-secondary mb-4" onclick="addCriterion('certification')">+ Add
                    Criterion</button>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary">+ Add JD</button>
                </div>
            </form>
        </main>
    </div>
    <script>
        async function submitForm(event) {
            event.preventDefault(); // Ngăn chặn reload trang

            let jobName = document.getElementById("name").value.trim();
            if (!jobName) {
                alert("Please enter the Job Name!");
                return;
            }

            let criteriaSections = ["background", "project", "skill", "certification"];
            let criteriaData = {};

            criteriaSections.forEach(section => {
                let sectionEl = document.getElementById(section);
                let importanceInput = sectionEl.querySelector(".importance-input");
                let importance = importanceInput ? parseInt(importanceInput.value, 10) || 0 : 0;

                let requiredTextarea = sectionEl.querySelector("textarea");
                let requiredText = requiredTextarea ? requiredTextarea.value.trim() : "";

                let extraCriteria = [];
                sectionEl.querySelectorAll(".criterion-row").forEach(row => {
                    let text = row.querySelector("textarea").value.trim();
                    let maxPoint = parseInt(row.querySelector("input[type=number]").value, 10) || 0;
                    if (text) {
                        extraCriteria.push({ text, max_point: maxPoint });
                    }
                });

                criteriaData[section] = {
                    importance,
                    required: requiredText,
                    extra_criteria: extraCriteria
                };
            });

            let payload = {
                name: jobName,
                criteria: criteriaData
            };

            try {
                let response = await fetch("/addjob", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                let result = await response.json();
                alert(result.message);
            } catch (error) {
                console.error("Error submitting job:", error);
                alert("Failed to submit the job. Please try again.");
            }
        }


        function addCriterion(sectionId, criterion = "") {
            let section = document.getElementById(sectionId);
            if (!section) return;

            let div = document.createElement("div");
            div.className = "mb-1 d-flex align-items-center gap-2 criterion-row";
            div.innerHTML = `
                <textarea rows="1" class="form-control w-75" placeholder="Criterion" required>${criterion}</textarea>
                <input type="number" class="form-control w-25" placeholder="Max point" min="0" max="100" value="10" required>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeCriterion(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            section.appendChild(div);
        }

        function removeCriterion(button) {
            button.parentElement.remove();
        }

        function updatePlaceholders(event) {
            const inputs = document.querySelectorAll('.importance-input');
            const currentInput = event?.target || null;

            // Nếu đang chỉnh 1 ô, ta chặn để tổng không vượt 100
            if (currentInput) {
                let val = parseInt(currentInput.value, 10);
                if (isNaN(val)) {
                    val = 0; // Nếu không phải số, tạm xem như 0
                }
                // Tính tổng các ô khác
                let sumOthers = 0;
                inputs.forEach(inp => {
                    if (inp !== currentInput) {
                        let otherVal = parseInt(inp.value, 10);
                        if (!isNaN(otherVal)) {
                            sumOthers += otherVal;
                        }
                    }
                });
                // Nếu sumOthers + val > 100 => ép val = 100 - sumOthers
                let maxVal = 100 - sumOthers;
                if (maxVal < 0) maxVal = 0;  // nếu các ô khác đã vượt 100 thì ép ô này = 0
                if (val > maxVal) {
                    val = maxVal;
                }
                if (val < 0) val = 0; // chặn giá trị âm
                if (val > 100) val = 100; // chặn giá trị > 100
                currentInput.value = val;
            }

            // Sau khi chặn giá trị ô hiện tại, ta tính lại total và ô trống
            let total = 0;
            let emptyInputs = [];
            inputs.forEach(input => {
                let val = parseInt(input.value, 10);
                if (!isNaN(val)) {
                    total += val;
                } else {
                    emptyInputs.push(input);
                }
            });
            let remaining = 100 - total;

            // Logic cũ – nếu chỉ 1 ô trống, tự điền phần còn lại
            // Nếu nhiều ô trống, cập nhật placeholder
            if (emptyInputs.length === 1) {
                emptyInputs[0].value = Math.max(0, remaining);
            } else {
                emptyInputs.forEach(input => {
                    input.placeholder = `Enter importance weight | Max = ${Math.max(0, remaining)}%`;
                });
            }

            // Nếu total = 0, set tất cả các ô sau ô vừa sửa = 0
            if (total === 0 && currentInput) {
                const editedIndex = Array.from(inputs).indexOf(currentInput);
                const subsequentInputs = Array.from(inputs).slice(editedIndex + 1);
                subsequentInputs.forEach(inp => {
                    inp.value = 0;
                });
            }
        }

        document.querySelectorAll('.importance-input').forEach(input => {
            input.setAttribute("step", "1");
            input.addEventListener('blur', updatePlaceholders);
            input.addEventListener('paste', () => setTimeout(updatePlaceholders, 0));
        });

    </script>
</body>

</html>